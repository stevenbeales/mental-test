<!DOCTYPE html>

<html>
<head>
<meta charset="UTF-8">

<title>module ActiveRecord::CounterCache::ClassMethods - RDoc Documentation</title>

<script type="text/javascript">
  var rdoc_rel_prefix = "../../";
  var index_rel_prefix = "../../";
</script>

<script src="../../js/jquery.js"></script>
<script src="../../js/darkfish.js"></script>

<link href="../../css/fonts.css" rel="stylesheet">
<link href="../../css/rdoc.css" rel="stylesheet">



<body id="top" role="document" class="module">
<nav role="navigation">
  <div id="project-navigation">
    <div id="home-section" role="region" title="Quick navigation" class="nav-section">
  <h2>
    <a href="../../index.html" rel="home">Home</a>
  </h2>

  <div id="table-of-contents-navigation">
    <a href="../../table_of_contents.html#pages">Pages</a>
    <a href="../../table_of_contents.html#classes">Classes</a>
    <a href="../../table_of_contents.html#methods">Methods</a>
  </div>
</div>

    <div id="search-section" role="search" class="project-section initially-hidden">
  <form action="#" method="get" accept-charset="utf-8">
    <div id="search-field-wrapper">
      <input id="search-field" role="combobox" aria-label="Search"
             aria-autocomplete="list" aria-controls="search-results"
             type="text" name="search" placeholder="Search" spellcheck="false"
             title="Type to search, Up and Down to navigate, Enter to load">
    </div>

    <ul id="search-results" aria-label="Search Results"
        aria-busy="false" aria-expanded="false"
        aria-atomic="false" class="initially-hidden"></ul>
  </form>
</div>

  </div>

  

  <div id="class-metadata">
    
    
    
    
    <!-- Method Quickref -->
<div id="method-list-section" class="nav-section">
  <h3>Methods</h3>

  <ul class="link-list" role="directory">
    
    <li ><a href="#method-i-decrement_counter">#decrement_counter</a>
    
    <li ><a href="#method-i-increment_counter">#increment_counter</a>
    
    <li ><a href="#method-i-reset_counters">#reset_counters</a>
    
    <li ><a href="#method-i-update_counters">#update_counters</a>
    
  </ul>
</div>

  </div>
</nav>

<main role="main" aria-labelledby="module-ActiveRecord::CounterCache::ClassMethods">
  <h1 id="module-ActiveRecord::CounterCache::ClassMethods" class="module">
    module ActiveRecord::CounterCache::ClassMethods
  </h1>

  <section class="description">
    
  </section>

  
  
  
  <section id="5Buntitled-5D" class="documentation-section">
    

    

    

    

    
     <section id="public-instance-5Buntitled-5D-method-details" class="method-section">
       <header>
         <h3>Public Instance Methods</h3>
       </header>

    
      <div id="method-i-decrement_counter" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">decrement_counter</span><span
            class="method-args">(counter_name, id, touch: nil)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Decrement a numeric field by one, via a direct SQL update.</p>

<p>This works the same as <a
href="ClassMethods.html#method-i-increment_counter">increment_counter</a>
but reduces the column value by 1 instead of increasing it.</p>

<h4 id="method-i-decrement_counter-label-Parameters">Parameters<span><a href="#method-i-decrement_counter-label-Parameters">&para;</a> <a href="#top">&uarr;</a></span></h4>
<ul><li>
<p><code>counter_name</code> - The name of the field that should be
decremented.</p>
</li><li>
<p><code>id</code> - The id of the object that should be decremented or an
array of ids.</p>
</li><li>
<p><code>:touch</code> - Touch timestamp columns when updating. Pass
<code>true</code> to touch <code>updated_at</code> and/or
<code>updated_on</code>. Pass a symbol to touch that column or an array of
symbols to touch just those ones.</p>
</li></ul>

<h4 id="method-i-decrement_counter-label-Examples">Examples<span><a href="#method-i-decrement_counter-label-Examples">&para;</a> <a href="#top">&uarr;</a></span></h4>

<pre class="ruby"><span class="ruby-comment"># Decrement the posts_count column for the record with an id of 5</span>
<span class="ruby-constant">DiscussionBoard</span>.<span class="ruby-identifier">decrement_counter</span>(:<span class="ruby-identifier">posts_count</span>, <span class="ruby-value">5</span>)

<span class="ruby-comment"># Decrement the posts_count column for the record with an id of 5</span>
<span class="ruby-comment"># and update the updated_at value.</span>
<span class="ruby-constant">DiscussionBoard</span>.<span class="ruby-identifier">decrement_counter</span>(:<span class="ruby-identifier">posts_count</span>, <span class="ruby-value">5</span>, <span class="ruby-identifier">touch</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>)
</pre>
          
          

          
          <div class="method-source-code" id="decrement_counter-source">
            <pre><span class="ruby-comment"># File vendor/bundle/ruby/2.4.0/gems/activerecord-5.1.5/lib/active_record/counter_cache.rb, line 163</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">decrement_counter</span>(<span class="ruby-identifier">counter_name</span>, <span class="ruby-identifier">id</span>, <span class="ruby-identifier">touch</span><span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>)
  <span class="ruby-identifier">update_counters</span>(<span class="ruby-identifier">id</span>, <span class="ruby-identifier">counter_name</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">-1</span>, <span class="ruby-identifier">touch</span><span class="ruby-operator">:</span> <span class="ruby-identifier">touch</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-increment_counter" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">increment_counter</span><span
            class="method-args">(counter_name, id, touch: nil)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Increment a numeric field by one, via a direct SQL update.</p>

<p>This method is used primarily for maintaining counter_cache columns that
are used to store aggregate values. For example, a
<code>DiscussionBoard</code> may cache posts_count and comments_count to
avoid running an SQL query to calculate the number of posts and comments
there are, each time it is displayed.</p>

<h4 id="method-i-increment_counter-label-Parameters">Parameters<span><a href="#method-i-increment_counter-label-Parameters">&para;</a> <a href="#top">&uarr;</a></span></h4>
<ul><li>
<p><code>counter_name</code> - The name of the field that should be
incremented.</p>
</li><li>
<p><code>id</code> - The id of the object that should be incremented or an
array of ids.</p>
</li><li>
<p><code>:touch</code> - Touch timestamp columns when updating. Pass
<code>true</code> to touch <code>updated_at</code> and/or
<code>updated_on</code>. Pass a symbol to touch that column or an array of
symbols to touch just those ones.</p>
</li></ul>

<h4 id="method-i-increment_counter-label-Examples">Examples<span><a href="#method-i-increment_counter-label-Examples">&para;</a> <a href="#top">&uarr;</a></span></h4>

<pre class="ruby"><span class="ruby-comment"># Increment the posts_count column for the record with an id of 5</span>
<span class="ruby-constant">DiscussionBoard</span>.<span class="ruby-identifier">increment_counter</span>(:<span class="ruby-identifier">posts_count</span>, <span class="ruby-value">5</span>)

<span class="ruby-comment"># Increment the posts_count column for the record with an id of 5</span>
<span class="ruby-comment"># and update the updated_at value.</span>
<span class="ruby-constant">DiscussionBoard</span>.<span class="ruby-identifier">increment_counter</span>(:<span class="ruby-identifier">posts_count</span>, <span class="ruby-value">5</span>, <span class="ruby-identifier">touch</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>)
</pre>
          
          

          
          <div class="method-source-code" id="increment_counter-source">
            <pre><span class="ruby-comment"># File vendor/bundle/ruby/2.4.0/gems/activerecord-5.1.5/lib/active_record/counter_cache.rb, line 138</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">increment_counter</span>(<span class="ruby-identifier">counter_name</span>, <span class="ruby-identifier">id</span>, <span class="ruby-identifier">touch</span><span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>)
  <span class="ruby-identifier">update_counters</span>(<span class="ruby-identifier">id</span>, <span class="ruby-identifier">counter_name</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-value">1</span>, <span class="ruby-identifier">touch</span><span class="ruby-operator">:</span> <span class="ruby-identifier">touch</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-reset_counters" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">reset_counters</span><span
            class="method-args">(id, *counters, touch: nil)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>Resets one or more counter caches to their correct value using an SQL count
query. This is useful when adding new counter caches, or if the counter has
been corrupted or modified directly by SQL.</p>

<h4 id="method-i-reset_counters-label-Parameters">Parameters<span><a href="#method-i-reset_counters-label-Parameters">&para;</a> <a href="#top">&uarr;</a></span></h4>
<ul><li>
<p><code>id</code> - The id of the object you wish to reset a counter on.</p>
</li><li>
<p><code>counters</code> - <a href="../../One.html">One</a> or more
association counters to reset. Association name or counter name can be
given.</p>
</li><li>
<p><code>:touch</code> - Touch timestamp columns when updating. Pass
<code>true</code> to touch <code>updated_at</code> and/or
<code>updated_on</code>. Pass a symbol to touch that column or an array of
symbols to touch just those ones.</p>
</li></ul>

<h4 id="method-i-reset_counters-label-Examples">Examples<span><a href="#method-i-reset_counters-label-Examples">&para;</a> <a href="#top">&uarr;</a></span></h4>

<pre class="ruby"><span class="ruby-comment"># For the Post with id #1, reset the comments_count</span>
<span class="ruby-constant">Post</span>.<span class="ruby-identifier">reset_counters</span>(<span class="ruby-value">1</span>, :<span class="ruby-identifier">comments</span>)

<span class="ruby-comment"># Like above, but also touch the +updated_at+ and/or +updated_on+</span>
<span class="ruby-comment"># attributes.</span>
<span class="ruby-constant">Post</span>.<span class="ruby-identifier">reset_counters</span>(<span class="ruby-value">1</span>, :<span class="ruby-identifier">comments</span>, <span class="ruby-identifier">touch</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>)
</pre>
          
          

          
          <div class="method-source-code" id="reset_counters-source">
            <pre><span class="ruby-comment"># File vendor/bundle/ruby/2.4.0/gems/activerecord-5.1.5/lib/active_record/counter_cache.rb, line 27</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">reset_counters</span>(<span class="ruby-identifier">id</span>, <span class="ruby-operator">*</span><span class="ruby-identifier">counters</span>, <span class="ruby-identifier">touch</span><span class="ruby-operator">:</span> <span class="ruby-keyword">nil</span>)
  <span class="ruby-identifier">object</span> = <span class="ruby-identifier">find</span>(<span class="ruby-identifier">id</span>)

  <span class="ruby-identifier">counters</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">counter_association</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">has_many_association</span> = <span class="ruby-identifier">_reflect_on_association</span>(<span class="ruby-identifier">counter_association</span>)
    <span class="ruby-keyword">unless</span> <span class="ruby-identifier">has_many_association</span>
      <span class="ruby-identifier">has_many</span> = <span class="ruby-identifier">reflect_on_all_associations</span>(<span class="ruby-value">:has_many</span>)
      <span class="ruby-identifier">has_many_association</span> = <span class="ruby-identifier">has_many</span>.<span class="ruby-identifier">find</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">association</span><span class="ruby-operator">|</span> <span class="ruby-identifier">association</span>.<span class="ruby-identifier">counter_cache_column</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">association</span>.<span class="ruby-identifier">counter_cache_column</span>.<span class="ruby-identifier">to_sym</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">counter_association</span>.<span class="ruby-identifier">to_sym</span> }
      <span class="ruby-identifier">counter_association</span> = <span class="ruby-identifier">has_many_association</span>.<span class="ruby-identifier">plural_name</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">has_many_association</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ArgumentError</span>, <span class="ruby-node">&quot;&#39;#{name}&#39; has no association called &#39;#{counter_association}&#39;&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">has_many_association</span>

    <span class="ruby-keyword">if</span> <span class="ruby-identifier">has_many_association</span>.<span class="ruby-identifier">is_a?</span> <span class="ruby-constant">ActiveRecord</span><span class="ruby-operator">::</span><span class="ruby-constant">Reflection</span><span class="ruby-operator">::</span><span class="ruby-constant">ThroughReflection</span>
      <span class="ruby-identifier">has_many_association</span> = <span class="ruby-identifier">has_many_association</span>.<span class="ruby-identifier">through_reflection</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">foreign_key</span>  = <span class="ruby-identifier">has_many_association</span>.<span class="ruby-identifier">foreign_key</span>.<span class="ruby-identifier">to_s</span>
    <span class="ruby-identifier">child_class</span>  = <span class="ruby-identifier">has_many_association</span>.<span class="ruby-identifier">klass</span>
    <span class="ruby-identifier">reflection</span>   = <span class="ruby-identifier">child_class</span>.<span class="ruby-identifier">_reflections</span>.<span class="ruby-identifier">values</span>.<span class="ruby-identifier">find</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">e</span><span class="ruby-operator">|</span> <span class="ruby-identifier">e</span>.<span class="ruby-identifier">belongs_to?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">e</span>.<span class="ruby-identifier">foreign_key</span>.<span class="ruby-identifier">to_s</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">foreign_key</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-identifier">e</span>.<span class="ruby-identifier">options</span>[<span class="ruby-value">:counter_cache</span>].<span class="ruby-identifier">present?</span> }
    <span class="ruby-identifier">counter_name</span> = <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">counter_cache_column</span>

    <span class="ruby-identifier">updates</span> = { <span class="ruby-identifier">counter_name</span>.<span class="ruby-identifier">to_sym</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">object</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">counter_association</span>).<span class="ruby-identifier">count</span>(<span class="ruby-value">:all</span>) }
    <span class="ruby-identifier">updates</span>.<span class="ruby-identifier">merge!</span>(<span class="ruby-identifier">touch_updates</span>(<span class="ruby-identifier">touch</span>)) <span class="ruby-keyword">if</span> <span class="ruby-identifier">touch</span>

    <span class="ruby-identifier">unscoped</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">primary_key</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">object</span>.<span class="ruby-identifier">id</span>).<span class="ruby-identifier">update_all</span>(<span class="ruby-identifier">updates</span>)
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">return</span> <span class="ruby-keyword">true</span>
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
      <div id="method-i-update_counters" class="method-detail ">
        
        <div class="method-heading">
          <span class="method-name">update_counters</span><span
            class="method-args">(id, counters)</span>
          
          <span class="method-click-advice">click to toggle source</span>
          
        </div>
        

        <div class="method-description">
          
          <p>A generic “counter updater” implementation, intended primarily to be used
by <a
href="ClassMethods.html#method-i-increment_counter">increment_counter</a>
and <a
href="ClassMethods.html#method-i-decrement_counter">decrement_counter</a>,
but which may also be useful on its own. It simply does a direct SQL update
for the record with the given ID, altering the given hash of counters by
the amount given by the corresponding value:</p>

<h4 id="method-i-update_counters-label-Parameters">Parameters<span><a href="#method-i-update_counters-label-Parameters">&para;</a> <a href="#top">&uarr;</a></span></h4>
<ul><li>
<p><code>id</code> - The id of the object you wish to update a counter on or
an array of ids.</p>
</li><li>
<p><code>counters</code> - A <a href="../../Hash.html">Hash</a> containing the
names of the fields to update as keys and the amount to update the field by
as values.</p>
</li><li>
<p><code>:touch</code> option - Touch timestamp columns when updating. Pass
<code>true</code> to touch <code>updated_at</code> and/or
<code>updated_on</code>. Pass a symbol to touch that column or an array of
symbols to touch just those ones.</p>
</li></ul>

<h4 id="method-i-update_counters-label-Examples">Examples<span><a href="#method-i-update_counters-label-Examples">&para;</a> <a href="#top">&uarr;</a></span></h4>

<pre class="ruby"><span class="ruby-comment"># For the Post with id of 5, decrement the comment_count by 1, and</span>
<span class="ruby-comment"># increment the action_count by 1</span>
<span class="ruby-constant">Post</span>.<span class="ruby-identifier">update_counters</span> <span class="ruby-value">5</span>, <span class="ruby-identifier">comment_count</span><span class="ruby-operator">:</span> <span class="ruby-value">-1</span>, <span class="ruby-identifier">action_count</span><span class="ruby-operator">:</span> <span class="ruby-value">1</span>
<span class="ruby-comment"># Executes the following SQL:</span>
<span class="ruby-comment"># UPDATE posts</span>
<span class="ruby-comment">#    SET comment_count = COALESCE(comment_count, 0) - 1,</span>
<span class="ruby-comment">#        action_count = COALESCE(action_count, 0) + 1</span>
<span class="ruby-comment">#  WHERE id = 5</span>

<span class="ruby-comment"># For the Posts with id of 10 and 15, increment the comment_count by 1</span>
<span class="ruby-constant">Post</span>.<span class="ruby-identifier">update_counters</span> [<span class="ruby-value">10</span>, <span class="ruby-value">15</span>], <span class="ruby-identifier">comment_count</span><span class="ruby-operator">:</span> <span class="ruby-value">1</span>
<span class="ruby-comment"># Executes the following SQL:</span>
<span class="ruby-comment"># UPDATE posts</span>
<span class="ruby-comment">#    SET comment_count = COALESCE(comment_count, 0) + 1</span>
<span class="ruby-comment">#  WHERE id IN (10, 15)</span>

<span class="ruby-comment"># For the Posts with id of 10 and 15, increment the comment_count by 1</span>
<span class="ruby-comment"># and update the updated_at value for each counter.</span>
<span class="ruby-constant">Post</span>.<span class="ruby-identifier">update_counters</span> [<span class="ruby-value">10</span>, <span class="ruby-value">15</span>], <span class="ruby-identifier">comment_count</span><span class="ruby-operator">:</span> <span class="ruby-value">1</span>, <span class="ruby-identifier">touch</span><span class="ruby-operator">:</span> <span class="ruby-keyword">true</span>
<span class="ruby-comment"># Executes the following SQL:</span>
<span class="ruby-comment"># UPDATE posts</span>
<span class="ruby-comment">#    SET comment_count = COALESCE(comment_count, 0) + 1,</span>
<span class="ruby-comment">#    `updated_at` = &#39;2016-10-13T09:59:23-05:00&#39;</span>
<span class="ruby-comment">#  WHERE id IN (10, 15)</span>
</pre>
          
          

          
          <div class="method-source-code" id="update_counters-source">
            <pre><span class="ruby-comment"># File vendor/bundle/ruby/2.4.0/gems/activerecord-5.1.5/lib/active_record/counter_cache.rb, line 98</span>
<span class="ruby-keyword">def</span> <span class="ruby-identifier">update_counters</span>(<span class="ruby-identifier">id</span>, <span class="ruby-identifier">counters</span>)
  <span class="ruby-identifier">touch</span> = <span class="ruby-identifier">counters</span>.<span class="ruby-identifier">delete</span>(<span class="ruby-value">:touch</span>)

  <span class="ruby-identifier">updates</span> = <span class="ruby-identifier">counters</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">counter_name</span>, <span class="ruby-identifier">value</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">operator</span> = <span class="ruby-identifier">value</span> <span class="ruby-operator">&lt;</span> <span class="ruby-value">0</span> <span class="ruby-operator">?</span> <span class="ruby-string">&quot;-&quot;</span> <span class="ruby-operator">:</span> <span class="ruby-string">&quot;+&quot;</span>
    <span class="ruby-identifier">quoted_column</span> = <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">quote_column_name</span>(<span class="ruby-identifier">counter_name</span>)
    <span class="ruby-node">&quot;#{quoted_column} = COALESCE(#{quoted_column}, 0) #{operator} #{value.abs}&quot;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">touch</span>
    <span class="ruby-identifier">touch_updates</span> = <span class="ruby-identifier">touch_updates</span>(<span class="ruby-identifier">touch</span>)
    <span class="ruby-identifier">updates</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">sanitize_sql_for_assignment</span>(<span class="ruby-identifier">touch_updates</span>) <span class="ruby-keyword">unless</span> <span class="ruby-identifier">touch_updates</span>.<span class="ruby-identifier">empty?</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">unscoped</span>.<span class="ruby-identifier">where</span>(<span class="ruby-identifier">primary_key</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">id</span>).<span class="ruby-identifier">update_all</span> <span class="ruby-identifier">updates</span>.<span class="ruby-identifier">join</span>(<span class="ruby-string">&quot;, &quot;</span>)
<span class="ruby-keyword">end</span></pre>
          </div>
          
        </div>

        

        
      </div>

    
    </section>
  
  </section>
</main>


<footer id="validator-badges" role="contentinfo">
  <p><a href="http://validator.w3.org/check/referer">Validate</a>
  <p>Generated by <a href="https://rdoc.github.io/rdoc">RDoc</a> 5.0.0.
  <p>Based on <a href="http://deveiate.org/projects/Darkfish-RDoc/">Darkfish</a> by <a href="http://deveiate.org">Michael Granger</a>.
</footer>

